name: Deploy FastFood to AKS

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  REGISTRY: acrfastfooddhyogo2025.azurecr.io
  APP_IMAGE_NAME: fastfood/users-app
  MIGRATOR_IMAGE_NAME: fastfood/migrator-users-app
  CHART_PATH: ./helm/fastfood-chart
  RELEASE_NAME: users-app-release
  AKS_RESOURCE_GROUP: rg-fastfood-postech
  AKS_CLUSTER_NAME: aks-fastfood-postech
  NAMESPACE: fastfood

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # 1. Checkout do c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup .NET (necess√°rio para build das imagens)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ============================================
      # DEPLOY TO AZURE
      # ============================================

      # Vari√°veis necess√°rias:
      # AZURE_CLIENT_ID - Client ID do Azure
      # AZURE_TENANT_ID - Tenant ID do Azure
      # AZURE_SUBSCRIPTION_ID - Subscription ID do Azure
      # POSTGRES_HOST - Host do PostgreSQL
      # POSTGRES_USER - Usu√°rio do PostgreSQL
      # POSTGRES_PASSWORD - Senha do PostgreSQL

      # 3. Login no Azure usando OIDC
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_DHYOGO }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID_DHYOGO }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DHYOGO }}
      # 2. Login no ACR
      - name: Azure Container Registry Login
        run: az acr login --name acrfastfooddhyogo2025

      # 5. Build e push das imagens Docker (App + Migrator)
      - name: Build and push Docker images
        run: |
          # Define a tag explicitamente como vari√°vel local do shell
          TAG=${{ github.sha }}
          
          # Build da Aplica√ß√£o (Target final)
          docker build --target final \
            -t $REGISTRY/$APP_IMAGE_NAME:$TAG \
            -t $REGISTRY/$APP_IMAGE_NAME:latest \
            -f Dockerfile .
          
          # Build do Migrator (Target migrator)
          docker build --target migrator \
            -t $REGISTRY/$MIGRATOR_IMAGE_NAME:$TAG \
            -t $REGISTRY/$MIGRATOR_IMAGE_NAME:latest \
            -f Dockerfile .

          # Push das imagens
          docker push $REGISTRY/$APP_IMAGE_NAME:$TAG
          docker push $REGISTRY/$APP_IMAGE_NAME:latest
          docker push $REGISTRY/$MIGRATOR_IMAGE_NAME:$TAG
          docker push $REGISTRY/$MIGRATOR_IMAGE_NAME:latest

      # 6. Conectar no AKS
      - name: Get AKS credentials
        run: |
          rm -rf ~/.kube/config || true
          az aks get-credentials \
            --resource-group $AKS_RESOURCE_GROUP \
            --name $AKS_CLUSTER_NAME \
            --overwrite-existing \
            --admin
          kubectl cluster-info
          kubectl get nodes

      # 8. Setup Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.15.1

      - name: Helm Lint
        run: helm lint $CHART_PATH

      - name: Create Namespace
        run: kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ACR Secret
        run: |
          kubectl create secret docker-registry acr-secret \
            --docker-server=$REGISTRY \
            --docker-username=$(az acr credential show --name acrfastfooddhyogo2025 --query "username" -o tsv) \
            --docker-password=$(az acr credential show --name acrfastfooddhyogo2025 --query "passwords[0].value" -o tsv) \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

      # 9. Executar Migration Job
      - name: Run Database Migration
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üßπ Limpando job anterior..."
          kubectl delete job users-migrator -n $NAMESPACE --ignore-not-found=true
          
          echo "üöÄ Renderizando e aplicando Job de Migra√ß√£o..."
          helm template migrator-job $CHART_PATH \
            --set image.migratorRepository=$REGISTRY/$MIGRATOR_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            --set postgres.host="${{ secrets.POSTGRES_HOST }}" \
            --set postgres.db="${{ secrets.POSTGRES_DB_USERS }}" \
            --set credentials.user="${{ secrets.POSTGRES_USER }}" \
            --set credentials.password="${{ secrets.POSTGRES_PASSWORD }}" \
            --namespace $NAMESPACE \
            --show-only templates/migrator-job.yaml \
            --show-only templates/config-map.yaml \
            --show-only templates/secret.yaml | kubectl apply -f -
          
          echo "‚è≥ Aguardando migra√ß√£o finalizar..."
          kubectl wait --for=condition=complete job/users-migrator -n $NAMESPACE --timeout=300s 

      # 8. Limpar recursos √≥rf√£os (se existirem)
      - name: Clean up orphaned resources
        run: |
          echo "üßπ Removendo releases e recursos √≥rf√£os anteriores..."
          helm uninstall $RELEASE_NAME -n $NAMESPACE --ignore-not-found || true
          kubectl delete configmap users-config -n $NAMESPACE --ignore-not-found || true
          kubectl delete configmap fastfood-config -n $NAMESPACE --ignore-not-found || true
          kubectl delete secret db-credentials -n $NAMESPACE --ignore-not-found || true
          sleep 5

      # 9. Deploy da Aplica√ß√£o (Com rollback autom√°tico)
      - name: Deploy Application via Helm
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Atualiza/Cria secret do ACR para o K8s puxar a imagem
          kubectl create secret docker-registry acr-secret \
            --docker-server=$REGISTRY \
            --docker-username=$(az acr credential show --name acrfastfooddhyogo2025 --query "username" -o tsv) \
            --docker-password=$(az acr credential show --name acrfastfooddhyogo2025 --query "passwords[0].value" -o tsv) \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Upgrade At√¥mico (Se falhar, desfaz tudo) com timeout estendido
          helm upgrade --install $RELEASE_NAME $CHART_PATH \
            --namespace $NAMESPACE \
            --create-namespace \
            --set postgres.host="${{ secrets.POSTGRES_HOST }}" \
            --set postgres.db="${{ secrets.POSTGRES_DB_USERS }}" \
            --set postgres.port="5432" \
            --set credentials.user="${{ secrets.POSTGRES_USER }}" \
            --set credentials.password="${{ secrets.POSTGRES_PASSWORD }}" \
            --set image.repository=$REGISTRY/$APP_IMAGE_NAME \
            --set image.tag=${{ github.sha }} \
            --timeout=20m \
            --wait \
            --atomic

      # 10. Verificar status do deployment
      - name: Verify Deployment
        run: |
          echo "üìä Verificando status do deployment..."
          kubectl rollout status deployment/users-app -n $NAMESPACE --timeout=5m
          kubectl get pods -n $NAMESPACE -l app=users-app
          echo "‚úÖ Deploy conclu√≠do com sucesso!"